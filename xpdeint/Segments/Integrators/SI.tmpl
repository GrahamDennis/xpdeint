@*
SI.tmpl

Created by Joe Hope on 2008-03-24.
Copyright (c) 2008 __MyCompanyName__. All rights reserved.
*@
@extends xpdeint.Segments.Integrators.FixedStep

@def description: segment $segmentNumber (SI Integrator)
@attr $ipPropagationStepFractions = ['0.5']
@attr $extraIntegrationArrayNames = ['oldCopy']
@attr $isCrossCapable = True

@*
  Single integration step (SI)
*@
@def singleIntegrationStep
  @#

_segment${segmentNumber}_ip_evolve(+1);

${propagationDimension} += _step/2.0;

${transformVectorsToSpace($integrationVectors, $homeSpace)}@slurp

${loopOverVectorsWithInnerContentTemplate($integrationVectors,
"""// oldCopy = a
_oldCopy_${vector.id}[$index] = _${vector.id}[$index];
""")}@slurp

@for $vector in $integrationVectors
  _active_${vector.id} = _${vector.id};
@end for

// _segment1_x_propagate(_step);
for (int _iteration=0; _iteration<${iterations}-1; _iteration++) {
  _segment${segmentNumber}_calculate_delta_a(_step/2);

  ${loopOverVectorsWithInnerContentTemplate($integrationVectors,
  """// a = oldCopy + a
  _${vector.id}[$index] += _oldCopy_${vector.id}[$index];
  """)}@slurp
}

_segment${segmentNumber}_calculate_delta_a(_step);

${loopOverVectorsWithInnerContentTemplate($integrationVectors,
"""// a = oldCopy + a
_${vector.id}[$index] += _oldCopy_${vector.id}[$index];
""")}@slurp

_segment${segmentNumber}_ip_evolve(+1);

${propagationDimension} += _step/2.0;

  @if $cross
${updateDependenciesForNextStep}@slurp
  @end if

  @#
@end def

